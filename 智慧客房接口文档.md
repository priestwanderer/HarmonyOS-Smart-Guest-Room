# 智慧客房接口文档

## 项目概述

智慧客房系统是一个基于HarmonyOS的酒店客房控制应用，为用户提供客房设备的远程控制功能，包括空调、灯光等设备的智能化管理。

## 接口基础信息

- **基础URL**: `https://ohosiot.admitpro.cn`
- **认证方式**: Bearer Token
- **数据格式**: JSON
- **字符编码**: UTF-8

## 认证机制

所有设备控制接口都需要在请求头中携带有效的访问令牌：

```http
Authorization: Bearer {token}
```

令牌通过登录接口获取，有效期内可用于所有需要认证的接口调用。

## 通用响应格式

### 成功响应
```json
{
  "code": 0,           // 业务状态码，0表示成功
  "msg": "success",    // 响应消息
  "data": {}          // 响应数据（可选）
}
```

### 错误响应
```json
{
  "code": 1,                    // 业务状态码，非0表示错误
  "msg": "错误描述信息",        // 错误描述
  "data": {}                   // 错误详情（可选）
}
```

### 状态码说明

| 业务状态码 | HTTP状态码 | 说明 |
|-----------|-----------|------|
| 0/200     | 200       | 请求成功 |
| 非0       | 200       | 业务处理失败 |
| -         | 4xx       | 客户端请求错误 |
| -         | 5xx       | 服务器内部错误 |

---

## 1. 用户登录

**接口地址**: `/api/sso/login`
**请求方法**: POST
**接口描述**: 用户登录获取访问令牌

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| roomNo | string | 是 | 客房号 | "2002" |
| firstName | string | 是 | 用户名 | "xiao" |

### 请求示例

```json
{
  "roomNo": "2002",
  "firstName": "xiao"
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| code | number | 业务状态码，0表示成功 |
| msg | string | 响应消息 |
| data | string | 访问令牌（token） |

### 响应示例

```json
{
  "code": 0,
  "msg": "登录成功",
  "data": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 错误示例

```json
{
  "code": 1,
  "msg": "客房号或用户名错误"
}
```

---

## 2. 获取客房状态

**接口地址**: `/api/rcu/room/getState`
**请求方法**: POST
**接口描述**: 获取客房设备当前状态信息
**是否需要认证**: 是

### 请求头

```http
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| roomNo | string | 否 | 客房号，默认"2002" | "2002" |

### 请求示例

```json
{
  "roomNo": "2002"
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| code | number | 业务状态码，0表示成功 |
| msg | string | 响应消息 |
| data | object | 客房设备状态数据 |

### 响应示例

```json
{
    "code": 0,
    "data": {
        "hasBidaMachine": false,
        "lightState": [],
        "room_number": "2002",
        "brightnessState": "",
        "singleBrightnessState": "",
        "state": {
            "qingli": "1",
            "wurao": "0",
            "light_mode_1": "2",
            "light_mode_2": "2",
            "shaohou": "0",
            "prefix": "AD",
            "infrared_trigger_state": "0",
            "tui": "0",
            "inspect_finish_flag": "0",
            "menci": "1",
            "sos": "0",
            "ruzhu": "1",
            "service_flag": "0",
            "light_mode_flag": "0",
            "mcu_type": "3",
            "power": "0000000",
            "electricity_flag_3": "0",
            "fuwu": "0",
            "electricity_flag_1": "0",
            "electricity_flag_2": "0",
            "ver": "99",
            "other_flag": "0",
            "yukai": "0",
            "kt2": {
                "mode": 0,
                "settingTemp": 16,
                "currentTemp": 16,
                "open": 0,
                "speed": 0
            },
            "kt1": {
                "mode": 0,
                "settingTemp": 22,
                "currentTemp": 19,
                "open": 1,
                "speed": 1
            },
            "kt4": {
                "mode": 0,
                "settingTemp": 0,
                "currentTemp": 0,
                "open": 0,
                "speed": 0
            },
            "kt3": {
                "mode": 0,
                "settingTemp": 16,
                "currentTemp": 16,
                "open": 0,
                "speed": 0
            },
            "voltage": "0000",
            "air_flag": "1",
            "electricity_flag": "0",
            "humidity_value": "000",
            "door_flag": "0",
            "light_mode_3": "3",
            "light_mode_4": "4",
            "card": "6",
            "light_mode_5": "5",
            "light_mode_6": "6"
        },
        "hotel_name": "肖总测试",
        "hardware": {
            "airs": [
                {
                    "code": "kt1",
                    "cpadd": "1",
                    "name": "空调1",
                    "location": "房间",
                    "id": 103136
                }
            ],
            "curtains": [
                {
                    "sequence": 0,
                    "cpadd": "2",
                    "name": "窗纱",
                    "location": "房间",
                    "id": 103127
                },
                {
                    "sequence": 0,
                    "cpadd": "1",
                    "name": "窗帘1",
                    "location": "房间",
                    "id": 103137
                }
            ],
            "hasElectricityStatistic": false,
            "hasCurtain": true,
            "hasOnlineLockV2": false,
            "services": [
                {
                    "code": "wurao",
                    "name": "请勿打扰",
                    "id": 103138
                },
                {
                    "code": "qingli",
                    "name": "清理房间",
                    "id": 103139
                }
            ],
            "lightModes": [
                {
                    "cpadd": "1",
                    "name": "明亮模式",
                    "extra_name": null,
                    "location": "房间",
                    "id": 103119
                },
                {
                    "cpadd": "2",
                    "name": "柔和模式",
                    "extra_name": null,
                    "location": "房间",
                    "id": 103120
                },
                {
                    "cpadd": "3",
                    "name": "阅读模式",
                    "extra_name": null,
                    "location": "房间",
                    "id": 103121
                },
                {
                    "cpadd": "4",
                    "name": "温馨模式",
                    "extra_name": null,
                    "location": "房间",
                    "id": 103122
                },
                {
                    "cpadd": "C",
                    "name": "睡眠模式",
                    "extra_name": null,
                    "location": "房间",
                    "id": 103123
                }
            ],
            "hasLightOnOffControl": true,
            "tvs": [],
            "hasBrightness": false,
            "hasAligenieControl": false,
            "brightness": [],
            "hasLightBrightnessControl": false,
            "hasOnlineLock": false,
            "hasTv": false,
            "hasPanelBacklightControl": false,
            "hasAiphoneControl": false,
            "lights": [
                {
                    "cpadd": "60",
                    "name": "洗漱间",
                    "location": "房间",
                    "id": 103125
                },
                {
                    "cpadd": "23",
                    "name": "衣柜灯",
                    "location": "房间",
                    "id": 103128
                },
                {
                    "cpadd": "15",
                    "name": "落地灯",
                    "location": "房间",
                    "id": 103129
                },
                {
                    "cpadd": "14",
                    "name": "吧灯",
                    "location": "房间",
                    "id": 103130
                },
                {
                    "cpadd": "13",
                    "name": "书桌灯",
                    "location": "房间",
                    "id": 103131
                },
                {
                    "cpadd": "12",
                    "name": "右阅读灯",
                    "location": "房间",
                    "id": 103132
                },
                {
                    "cpadd": "11",
                    "name": "左阅读灯",
                    "location": "房间",
                    "id": 103133
                },
                {
                    "cpadd": "9",
                    "name": "排风扇",
                    "location": "房间",
                    "id": 103134
                },
                {
                    "cpadd": "1",
                    "name": "廊灯",
                    "location": "走廊",
                    "id": 103135
                }
            ]
        }
    },
    "success": true
}
```

---

## 3. 灯光控制

**接口地址**: `/api/rcu/room/setLightMode`
**请求方法**: POST
**接口描述**: 设置客房灯光模式
**是否需要认证**: 是

### 请求头

```http
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| roomNo | string | 否 | 客房号，默认"2002" | "2002" |
| hardwareId | number | 是 | 灯光硬件ID | 103001 |

### 硬件ID对照表

| hardwareId | 灯光模式 | 说明 |
|-----------|----------|------|
| 103001 | 明亮模式 | 客厅、卧室灯光全开 |
| 103002 | 起夜模式 | 夜灯模式，柔和照明 |
| 103003 | 温馨模式 | 暖色调氛围灯 |
| 103004 | 总关模式 | 所有灯光关闭 |

### 请求示例

```json
{
  "roomNo": "2002",
  "hardwareId": 103001
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| code | number | 业务状态码，0表示成功 |
| msg | string | 响应消息 |
| data | object | 操作结果数据（可选） |

### 响应示例

```json
{
    "code": 0,
    "data": "success",
    "success": true
}
```

---

## 4. 空调控制

**接口地址**: `/api/rcu/room/clickAirBtn`
**请求方法**: POST
**接口描述**: 控制空调设备（温度、模式、风速等）
**是否需要认证**: 是

### 请求头

```http
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| roomNo | string | 否 | 客房号，默认"2002" | "2002" |
| airId | number | 否 | 空调设备ID，默认103136 | 103136 |
| cmd | string | 否 | 控制命令，默认"temp" | "temp" |
| value | number | 是 | 控制值 | 24 |

### 控制命令说明

| cmd | value类型 | 说明 |
|-----|-----------|------|
| temp | number | 设置温度（16-30℃） |
| mode | number | 设置模式：1=制冷，2=制热，3=送风，4=除湿 |
| speed | number | 设置风速：1=低，2=中，3=高，0=自动 |
| power | number | 开关控制：0=关，1=开 |

### 请求示例

```json
{
  "roomNo": "2002",
  "airId": 103136,
  "cmd": "temp",
  "value": 24
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| code | number | 业务状态码，0表示成功 |
| msg | string | 响应消息 |
| data | object | 操作结果数据（可选） |

### 响应示例

```json
{
    "code": 0,
    "data": "success",
    "success": true
}
```

---

## 错误处理

### 常见错误码

| 错误码 | 错误信息 | 解决方案 |
|--------|----------|----------|
| 401 | 未授权访问 | 检查token是否有效 |
| 403 | 权限不足 | 确认用户权限 |
| 404 | 资源不存在 | 检查接口URL和参数 |
| 500 | 服务器内部错误 | 联系技术支持 |

### 业务错误

| 错误场景 | 错误信息 | 处理建议 |
|----------|----------|----------|
| 登录失败 | 客房号或用户名错误 | 检查输入参数 |
| 设备控制失败 | 设备离线或无响应 | 检查设备连接状态 |
| 参数错误 | 参数格式不正确 | 检查请求参数格式 |

---

## 接口调用示例

### 完整调用流程

```typescript
// 1. 登录获取token
const loginResponse = await fetch('https://ohosiot.admitpro.cn/api/sso/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    roomNo: "2002",
    firstName: "xiao"
  })
});
const { data: token } = await loginResponse.json();

// 2. 获取客房状态
const roomStateResponse = await fetch('https://ohosiot.admitpro.cn/api/rcu/room/getState', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ roomNo: "2002" })
});

// 3. 设置灯光模式
const lightResponse = await fetch('https://ohosiot.admitpro.cn/api/rcu/room/setLightMode', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    roomNo: "2002",
    hardwareId: 103001
  })
});

// 4. 设置空调温度
const airResponse = await fetch('https://ohosiot.admitpro.cn/api/rcu/room/clickAirBtn', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    roomNo: "2002",
    airId: 103136,
    cmd: "temp",
    value: 24
  })
});
```

---

## 技术实现

### 项目结构
```
hotel/
├── entry/src/main/ets/
│   ├── Apiservice/           # API服务层
│   │   └── Apiservice.ets    # 接口定义和实现
```

### 技术特点
- **架构模式**: MVVM（Model-View-ViewModel）
- **网络框架**: HarmonyOS @kit.NetworkKit （参考学习地址：https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/http-request）
- **数据存储**: HarmonyOS preferences API
- **防抖机制**: 空调温度控制采用防抖技术
- **错误处理**: 完整的网络和业务错误处理
- **日志记录**: 使用hilog进行调试和错误追踪

### 安全机制
- Token认证机制
- HTTP状态码验证
- 业务状态码检查
- 网络请求超时控制
- 输入参数验证

